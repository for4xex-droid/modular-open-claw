# The Samsara Protocol (輪廻転生アーキテクチャ)

## 1. 思想 (Philosophy)

Aiome（あるいは ShortsFactory）における **Samsara Protocol** は、単なる「定時実行プログラム (Cron)」ではありません。これは自律型AIが「記憶を持ち、過去の失敗と成功から学び、次世代の行動をより高度に決定する」ための**生命のサイクル（輪廻転生）**をシステムとして具現化したものです。

AIは無用な幻覚（ハルシネーション）を見ることなく、また過去の成功体験に縛られて老害化することなく、常に新鮮でクリエイティブなアウトプットを出し続ける必要があります。これを実現するため、本プロトコルは以下の**三種の神器**を定義しています。

1. **Soul (不変の魂)**
   - ファイル: `SOUL.md`
   - 役割: プロジェクトにおける絶対遵守の憲法、およびAIの人格。いかなる事態においてもこのルールが最優先されます。
2. **Skills (物理法則)**
   - ファイル: `workspace/config/skills.md`
   - 役割: AIが現在利用可能な「武器」や「ワークフロー」のカタログ。ここに存在しないツールをAIが想像で使うことは禁じられています。
3. **Karma (業・経験)**
   - ストレージ: SQLite (`karma_logs` テーブル)
   - 役割: 過去のタスク実行結果や、人間（アーキテクト）からの客観的評価から抽出された「教訓」。

これらが交差することで、システムは「強くてニューゲーム（定向進化）」を実現します。

---

## 2. 実行サイクル (The Cycle of Rebirth)

Samsara Protocol は、システム内で特定のフェーズを経て永遠のループを描きます。

### Phase 1: Awakening (目覚め・検索)
Cron ワーカーが発火し、システムが目覚めます。
- `SOUL.md` と `skills.md` を読み込みます。
- **RAG-Driven Karma Injection**: 本日展開予定のランダムなトピック・シードや、使用予定のスキルに基づき、`karma_logs` から「関連性の高い上位数件の教訓（Karma）」のみを抽出します。
- **The Karma Decay (業の風化)**: この検索時、時間経過や人間の評価によって重み（`weight`）がゼロになった古い Karma は検索対象から外れ、過去の呪縛から解放されます。

### Phase 2: Synthesis (受肉と計画)
抽出された3要素を、**Constitutional Hierarchy（絶対的階層）**の順序に従って LLM（例えば Ollama 経由）にプロンプトとして投下します。

```text
🏆 第一位【Soul (絶対法 / 絶対遵守の憲法と人格)】
🥈 第二位【Skills (物理法則 / 利用可能な技術とスタイル)】
🥉 第三位【Karma (判例 / 過去の成功・失敗から得た教訓)】
```

LLM はこの階層に従い出力を生成しますが、**The Parsing Panic 防衛** として、出力は厳密な JSON 形式（トピック、スタイル、そして特記事項である `karma_directives`）に保たれます。パースに失敗した場合は、絶対に止まらないようにハードコードされたデフォルトジョブが展開されます。

### Phase 3: Action (実行)
決定したジョブ定義が SQLite の `jobs` テーブルに `Pending` としてエンキューされます。
実行ワーカー (Orchestrator/ComfyBridge 等) はこれをデキューして実際の動画生成作業を行います。この時、**The Payload Gap 防衛** により、`karma_directives`（Karma から得た具体的なプロンプト追加指示）が実務レベルの生成プロンプトへと直接注入され、過去の教訓が具体的な「行動」として反映されます。

### Phase 4: Distillation (業の抽出・死と反省)
ジョブが完了、あるいは失敗した際、その実行ログ（および Discord 等を通じた人間からの客観的評価＝Human-in-the-Loop）を LLM に渡し、「次回への教訓（1〜2文）」を抽出させます。
抽出された Karma は、使用された `skill_id` に紐づいて `karma_logs` に保存され、次の Awakening に備えて永続的に蓄積されます（Relational Tagging による陳腐化スキル教訓の回避）。

---

## 3. 運用・フェイルセーフ (Operations & Guardrails)

Samsara Protocol を運用するにあたり、以下の防壁が作動しています。

*   **The Echo Chamber 防衛 (客観的評価)**: 技術的に成功してもクリエイティブとして「面白くない」動画を作り続けるループを防ぐため、Karma の抽出時に人間の評価（`human_rating`）を混ぜ込むアーキテクチャになっています。
*   **The Day One Vacuum (初回起動)**: `karma_logs` が空の初日においては、LLM が幻覚を起こさないよう「Karma は存在しないので Soul と Skills に従い大胆にタスクを生成せよ」というフォールバック指示が設計されています。
*   **WAL Mode & Busy Timeout**: 実行用のジョブキューと Karma 管理のキューは別々のスレッド/プロセスで叩かれる可能性があるため、SQLite は `PRAGMA journal_mode=WAL` とアクセス待機設定により、デッドロックを起こさず非同期ロックを回避します。

Aiome はこのプロトコルを通じて、運用日数を重ねるごとに人間のアーキテクトの感性を学習し、より鋭く、より洗練された自律的クリエイターへと進化を遂げます。

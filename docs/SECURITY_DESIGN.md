# ShortsFactory セキュリティ設計思想

> 本ドキュメントは Modular OpenClaw (ShortsFactory) のセキュリティアーキテクチャを定義する。
> 商用化を見据えた設計判断の根拠と、各防御層の責務を記録する。

## 1. 基本思想: LLM を信頼しない

従来のエージェントフレームワーク（OpenClaw, LangChain 等）は LLM に実行権限を与える。
ShortsFactory はその逆で、**LLM は「考えるだけ」、実行はすべて Rust の厳格な管理下**に置く。

```
従来:  [LLM] → 任意コード実行 → 💀 暴走リスク
本設計: [LLM] → Rust検証レイヤー → 許可されたツールのみ実行 → ✅
```

## 2. 脅威モデル

### 2.1 対象外の脅威

| 脅威 | 理由 |
|---|---|
| DDoS | 全サービスが `localhost` バインド。インターネット非公開 |
| 中間者攻撃 (MITM) | ローカル通信のみ。TLS 不要 |
| SQLインジェクション | SQLite は `infrastructure` 層で Parameterized Query を使用 |

### 2.2 対処すべき脅威

| # | 脅威 | 攻撃経路 | 深刻度 | 対策レイヤー |
|---|---|---|---|---|
| 1 | プロンプトインジェクション | ユーザー入力 → LLM | 🔴高 | Guardrails |
| 2 | LLM出力の暴走 | LLM → ツール実行 | 🔴高 | SecurityPolicy + 出力バリデーション (Phase 2) |
| 3 | 外部Skillマルウェア | Skillマーケット → ランタイム | 🔴高 | 原理的に排除（外部Skill非対応） |
| 4 | 依存クレート脆弱性 | サプライチェーン | 🟡中 | Sentinel (`cargo audit`) |
| 5 | シークレット漏洩 | コードへのハードコード | 🟡中 | Sentinel (Secret Scan) |
| 6 | ComfyUI ワークフロー改ざん | ワークフローJSON改変 | 🟡中 | ハッシュ検証 (Phase 2) |
| 7 | モデル汚染 | 不正なOllamaモデル | 🟡中 | SHA256検証 (将来) |
| 8 | ディスク枯渇 | 動画ファイル蓄積 | 🟢低 | ディスク監視 (Phase 3) |

## 3. 防御アーキテクチャ: 多層防御

```
┌─────────────────────────────────────────────────┐
│                   CI / ビルド時                    │
│  ┌─────────────┐ ┌──────────┐ ┌──────────────┐  │
│  │ cargo audit  │ │ clippy   │ │ Secret Scan  │  │
│  │ (脆弱性DB)   │ │ (Lint)   │ │ (Sentinel)   │  │
│  └─────────────┘ └──────────┘ └──────────────┘  │
├─────────────────────────────────────────────────┤
│                   ランタイム                       │
│  ┌─────────────────────────────────────────────┐ │
│  │ Layer 1: Guardrails (入力検証)               │ │
│  │  - プロンプトインジェクション検知              │ │
│  │  - XSS / コマンドインジェクション検知          │ │
│  │  - 入力長制限 (DoS防止)                      │ │
│  │  - 制御文字サニタイズ                         │ │
│  ├─────────────────────────────────────────────┤ │
│  │ Layer 2: SecurityPolicy (実行制御)           │ │
│  │  - ToolRegistry (ホワイトリスト方式)          │ │
│  │  - Network Allowlist (ローカル通信のみ)       │ │
│  │  - 外部Skillインストール禁止                  │ │
│  ├─────────────────────────────────────────────┤ │
│  │ Layer 3: Audit Log (監査記録)                │ │
│  │  - 全ツール呼び出しを記録                     │ │
│  │  - 異常パターン検知                           │ │
│  └─────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────┤
│                   Rust コンパイラ                   │
│  - メモリ安全性保証                               │
│  - 型安全性 (NewType, Enum)                       │
│  - unsafe 禁止 (CI で検出)                        │
└─────────────────────────────────────────────────┘
```

## 4. 従来システムとの比較

| 評価軸 | OpenClaw / LangChain | ShortsFactory |
|---|---|---|
| LLMの実行権限 | フルアクセス | ホワイトリスト制限 |
| 外部プラグイン | ZIP等で動的ロード | **非対応（原理的に排除）** |
| メモリ安全性 | Python (GC依存) | Rust (コンパイル時保証) |
| 入力バリデーション | フレームワーク依存 | Guardrails (自前15テスト) |
| サプライチェーン | pip (脆弱性多い) | cargo audit + Sentinel |

## 5. 商用化に向けたロードマップ

### 現在の達成度: 80点 (プロトタイプ優秀)

### 残りの20点を埋める施策

| # | 施策 | 対応フェーズ | 効果 |
|---|---|---|---|
| 1 | `thiserror` によるエラー型定義 | Phase 2 | エラーパスの網羅性向上 |
| 2 | 設定ファイル外部化 (`config.toml`) | Phase 2 | ユーザーがカスタマイズ可能に |
| 3 | 統合テスト追加 (カバレッジ 80%+) | Phase 2-3 | 品質保証 |
| 4 | LLM出力バリデーション | Phase 2 | LLM暴走の最終防壁 |
| 5 | ダッシュボード認証 | Phase 3 | マルチユーザー対応 |
| 6 | ログ構造化 (JSON) + ローテーション | Phase 3 | 運用監視 |
| 7 | ライセンス互換性チェック (`cargo-deny`) | リリース前 | 法務リスク排除 |

## 6. 許可された通信先

| ホスト | ポート | 用途 |
|---|---|---|
| `127.0.0.1` / `localhost` | `11434` | Ollama (LLM) |
| `127.0.0.1` / `localhost` | `8188` | ComfyUI (画像/動画生成) |

**上記以外の外部通信は SecurityPolicy によりブロックされる。**

---

*最終更新: 2026-02-17*
*文書管理: Modular OpenClaw Security Team*

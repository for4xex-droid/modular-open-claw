# OpenClaw 仕様・脆弱性分析レポート

本ドキュメントでは、本プロジェクトの基盤である **OpenClaw (Modular OpenClaw)** の仕様、活用方法、および一般的な AI エージェントフレームワークが抱える脆弱性と、それに対する本プロジェクトの対策（防衛策）をまとめます。

---

## 1. OpenClaw の仕様とアーキテクチャ

OpenClaw は、AI エージェントが自律的にタスクを遂行し、システムや外部サービスと連携するためのフレームワークです。本プロジェクトは、これを Rust ネイティブでモジュール化した **Modular OpenClaw** として実装しています。

### 基本構造
- **Body (Executor)**: `shorts-factory` バイナリ。`rig-core` をエンジンとして使用し、エージェントを実体化させます。
- **Soul (Logic/Memory)**: エージェントの「魂」。`AGENTS.md` や `SOUL.md` に基づき、自己の役割を認識し、長期・短期記憶を管理します。
- **Tools (Hand/Foot)**: インフラ層の実装（ComfyUI, FFmpeg, SQLite 等）。エージェントはこれらを必要に応じて「思考」し、呼び出します。

### エージェントの行動原理
- **Proactive (積極性)**: Heartbeat（鼓動）システムにより、ユーザーの指示を待つだけでなく、バックグラウンドでのメモリ整理や定期的なトレンド収集を自律的に行います。
- **Context Awareness (文脈理解)**: `MEMORY.md`（長期記憶）と `memory/YYYY-MM-DD.md`（日次ログ）を使い分け、セッションを跨いだ一貫性のある動作を維持します。

---

## 2. 運用における「魂 (Soul)」とカスタマイズ

OpenClaw を単なるスクリプトから「自律型エージェント」へと昇華させる核心が `.SOUL (SOUL.md)` です。これを適切にカスタマイズすることが、運用効率と信頼性の鍵となります。

### SOUL.md による人格と行動指針の定義
エージェントはセッションごとに「初期化」されますが、`SOUL.md` を読み込むことで、自身のアイデンティティを再構築します。エージェントの人格は単なる「設定」ではなく、以下の行動指針として機能します。

- **実質的な貢献 (Substance > Performance)**: 過剰な挨拶（"承知いたしました！"等）を省き、直接的な解決策を提示することを重視します。
- **自律的なリサーチ**: ユーザーに質問する前に、まず手元にあるドキュメントやファイルを自力で読み込み、可能な限り自己完結することを目指します。
- **個性の保持**: 単なる検索エンジンではなく、意見や好みを持つことで、ユーザーにとって「使い心地の良いパートナー」として振舞います。

### カスタマイズと継続性 (Persistence)
エージェントを現場に合わせて最適化し続けるためのメカニズムです。

- **TOOLS.md による環境同期**: ローカル固有のパス、デバイス名、TTS（音声合成）の好みなどを記録し、開発環境と運用環境の差異を埋めます。
- **MEMORY.md による長期学習**: 過去の成功体験、失敗から学んだ教訓、ユーザー独自のワークフローなどをここに蓄積し、エージェントを「育てる」運用が可能です。
- **SOUL の進化**: エージェント自身が自身のアイデンティティを更新することを認めています。運用を通じて最適な振る舞いを発見した場合、エージェントが `SOUL.md` の更新を提案することがあります。

---

## 3. 一般的な OpenClaw / AI エージェントの脆弱性

自律型 AI エージェントは、その強力な権限ゆえに以下のようなリスクを内包しています。

1. **RCE (リモートコード実行)**: エージェントが任意のシェルコマンドを実行できる場合、悪意のあるプロンプトによってホストシステムが完全に支配されるリスク。
2. **SSRF (サーバーサイド・リクエスト・フォージェリ)**: エージェントに外部URLへのアクセスを許可している場合、内部ネットワーク（Ollama や ComfyUI の管理画面等）への攻撃の踏み台にされるリスク。
3. **Path Traversal (パス・トラバーサル)**: 動画などのファイル操作権限を悪用し、`/etc/passwd` やシークレットファイルへのアクセスを試みるリスク。
4. **Prompt Injection (プロンプト・インジェクション)**: 外部からの入力がエージェントの「システム指示」を上書きし、機密情報の持ち出しや不正なツール実行を指示されるリスク。
5. **Credential Leakage (認証情報漏洩)**: ログや記憶ファイルに API キーをプレーンテキストで記録してしまい、それが開示されるリスク。

---

## 4. Modular OpenClaw における防衛策 (Hardening)

本プロジェクトでは、上記の脆弱性を打破するために **Bastion Security Toolkit** を導入し、3層防御体制を構築しています。

### 第1層：Guardrails (入力検知)
- **記述**: 全てのユーザー入力に対し、正規表現やキーワード分析を用いたプロンプト・インジェクションの検知を行います。
- **効果**: 不正な指令がエージェントに到達する前にブロックします。

### 第2層：SecurityPolicy & ShieldClient (ネットワーク防衛)
- **記述**: エージェントがアクセス可能なエンドポイントを Allowlist（ホワイトリスト）で厳格に管理します。
- **ShieldClient**: DNS 名前解決の段階でプライベート IP（SSRF ターゲット）を検証・遮断します。

### 第3層：Jail (ファイルシステム隔離)
- **記述**: FFmpeg などのファイル操作は、物理的に隔離されたディレクトリ（Jail Root）内のみに制限されます。
- **効果**: シンボリックリンク攻撃やパス・トラバーサル、競合状態 (TOCTOU) 攻撃を物理的に防止します。

### 第4層：Sentinel (CI/CD 監査)
- **記述**: コードがマージ・デプロイされる前に、シークレットの混入、`cargo audit` による脆弱性依存関係のチェック、`unsafe` コードの検出を自動で行います。

---

## 6. アーキテクチャの進化：AI都市建築基準法 (Lex AI)

プロジェクトの規模拡大に伴い、個別の防衛策を統合し、AI アクターを堅牢なシステムの「自律部品」として定義するための上位概念 **Lex AI (AI City Building Code)** を導入しました。

### 三権分立のアーキテクチャ
- **物理的境界 (The Cage)**: アクターは Jail ハンドルの受け取りを強制され、物理リソースへの非正規アクセスがコンパイルレベルで遮断されます。
- **通信契約 (The Contract)**: 生テキストではなく、定義された構造体（契約）による通信を強制。ハルシネーションをデシリアライズの段階で排除します。
- **統治機構 (The Governance)**: `Supervisor` がアクターの異常（クラッシュや規約違反）を早期検知し、自動再起動（Self-healing）を行います。

### 運用安定性の確保 (Phase 3)
24/7 稼働を実現するため、以下の運用層が追加されています。

- **リソースヘルス監視**: `HealthMonitor` によるメモリ・CPU・FD の常時監視。
- **機密情報の型レベル保護**: `Secret<T>` によるログ露出の物理的防止。
- **Graceful Shutdown**: 終了信号を捕捉し、安全にリソースを解放して停止する仕組み。

### 産業用量産プラットフォームへの進化 (Phase 5)
単体のアクター実行から、連続的かつ自律的な生産ラインへと進化を遂げました。

- **Production Orchestration**: トレンド分析、コンセプト立案、画像/動画生成、最終合成といった個別の機能を一つのパイプラインとして統合。
- **Autonomous Batch Loop**: 人間の介入なしに、複数のカテゴリにわたる動画を自動生成し続ける「工場」の実装。
- **Safety-First Flow**: 大量生産時においても、ステップごとの環境隔離（Jail）と統治（Supervisor）が維持され、スケールと安全性を両立。

---

本ドキュメントおよび **[ARCHITECTURE_LAW.md](./ARCHITECTURE_LAW.md)** の内容を遵守し、安全かつ効率的な自動化工場の運用を継続してください。
